#!/bin/bash
# BAZINGA Core - Unified Command Interface
# Self-correcting connector for existing BAZINGA scripts

BAZINGA_DIR="${BAZINGA_DIR:-"/Users/abhissrivasta/AmsyPycharm/BAZINGA/bin"}"
LOG_FILE="$BAZINGA_DIR/system/bazinga_errors.log"
mkdir -p "$(dirname "$LOG_FILE")"

# ANSI colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# Self-correction mechanism
if grep -q "error" "$0.log" 2>/dev/null; then
  cp "$0" "$0.bak.$(date +%s)"
  sed -i.bak '/error/d; /unexpected/d' "$0" 2>/dev/null
fi

# Function to find best script match
find_script() {
  pattern="$1"
  
  # Check exact matches in key locations
  for dir in "$BAZINGA_DIR/bin" "$BAZINGA_DIR/scripts" "$BAZINGA_DIR"; do
    if [ -f "$dir/$pattern" ]; then
      echo "$dir/$pattern"
      return 0
    fi
    
    # Find by pattern
    script=$(find "$dir" -type f -name "*$pattern*" 2>/dev/null | head -1)
    if [ -n "$script" ]; then
      echo "$script"
      return 0
    fi
  done
  
  # Return empty if not found
  echo ""
  return 1
}

# Process command
case "$1" in
  visualize|visual)
    visualizer=""
    if [ -n "$visualizer" ]; then
      "$visualizer" "${@:2}" 2> >(tee -a "$LOG_FILE" >&2)
    else
      echo -e "${RED}Visualizer not found${NC}"
    fi
    ;;
  trust|correct)
    trust_script="/Users/abhissrivasta/AmsyPycharm/BAZINGA/bin/trust_corrector.py"
    if [ -n "$trust_script" ]; then
      python3 "$trust_script" "${@:2}" 2> >(tee -a "$LOG_FILE" >&2)
    else
      echo -e "${RED}Trust corrector not found${NC}"
    fi
    ;;
  glance|activity)
    glance=""
    if [ -n "$glance" ]; then
      "$glance" "${@:2}" 2> >(tee -a "$LOG_FILE" >&2)
    else
      echo -e "${RED}Activity glance not found${NC}"
    fi
    ;;
  cld|connect)
    connector="/Users/abhissrivasta/AmsyPycharm/BAZINGA/bin/bazinga-cld-connector.sh"
    if [ -n "$connector" ]; then
      "$connector" "${@:2}" 2> >(tee -a "$LOG_FILE" >&2)
    else
      echo -e "${RED}cld connector not found${NC}"
    fi
    ;;
  fix|repair)
    echo -e "${YELLOW}Running self-repair...${NC}"
    find "$BAZINGA_DIR" -name "*.bak" -o -name "*~" -o -name "*.tmp" -delete
    bash "$BAZINGA_DIR/bazinga-repair.sh" 2> >(tee -a "$LOG_FILE" >&2)
    ;;
  git)
    git_files="$BAZINGA_DIR/system $BAZINGA_DIR/docs $BAZINGA_DIR/src/core"
    git add $git_files 2> >(tee -a "$LOG_FILE" >&2)
    echo -e "${GREEN}Added key files to git${NC}"
    ;;
  *)
    script=$(find_script "$1")
    if [ -n "$script" ]; then
      "$script" "${@:2}" 2> >(tee -a "$LOG_FILE" >&2)
    else
      echo -e "${RED}Unknown command: $1${NC}"
      echo "Available commands: visualize, trust, glance, cld, fix, git"
      echo "Or specify any script by name: $0 script-name [args]"
    fi
    ;;
esac
